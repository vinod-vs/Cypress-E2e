# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

parameters:
- name: baseUrl
  displayName: Base URL
  type: string
  default: https://uatsite.woolworths.com.au/
  values:
  - https://uatsite.woolworths.com.au/
  - https://wowguiaae.wowdevaae-ase.p.azurewebsites.net/
  - https://woolworths.com.au/
  - https://stagingsite.woolworths.com.au
  - https://preprodsite.woolworths.com.au

- name: browser
  displayName: Browser
  type: string
  default: chrome
  values:
  - chrome
  - edge
  - firefox
  - electron

trigger:
  - main

pool:
  name: wlx-ubuntu1804

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "14.x"
    displayName: "Install Node.js"

  - script: |
      npm install
      npm test baseUrl=${{ parameters.baseUrl }} browser ${{ parameters.browser }}
    displayName: "npm install and test"

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testRunner: 'JUnit'
      testResultsFiles: '**/results-*.xml'
      testRunTitle: WOwE2EAPI-$(Build.BuildNumber)
      mergeTestResults: true
      searchFolder: '$(System.DefaultWorkingDirectory)/cypress/results'
    displayName: "Generate test run"

  - task: SlackNotification@6
    inputs:
      SlackApiToken: 'xapp-1-A01QWL69C84-1840572733362-258f41954952aef3164b1782060b5e81dee1e75f7a271ed2b436abae9e68c4c1'
      MessageAuthor: 'Azure DevOps'
      Channel: 'wow-e2e-api-automation-notifications'
      NotificationType: 'ChatMessage'
      Message: |
        {
            "text": "Hello, World!"
        }
      AuthorName: 'Kristian'
      Title: 'Test'
